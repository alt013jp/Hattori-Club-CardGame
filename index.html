<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HATTORI CLUB CARD GAME ～ハットリ会会長決定戦～</title>
    <meta name="description" content="遊戯王風オリジナルカードゲーム。対戦モードとカード検証モードを搭載。">
    <link rel="stylesheet" href="style.css">
    <script>
        window.onerror = function (msg, url, line, col, error) {
            fetch('/log_error', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ msg: msg, stack: error ? error.stack : '' }) });
        };
        window.addEventListener('unhandledrejection', function (event) {
            fetch('/log_error', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ msg: 'Unhandled Rejection: ' + event.reason, stack: event.reason && event.reason.stack }) });
        });
    </script>
</head>

<body>

    <!-- ========== スマホ縦画面警告 ========== -->
    <div id="portrait-overlay">
        <div class="icon">📱🔄</div>
        <h2>デバイスを横向きにしてください</h2>
        <p style="margin-top:10px; font-size: 0.9rem; opacity: 0.8;">
            このゲームは横画面プレイ専用です。<br>スマートフォンの画面回転ロックを解除し、<br>横向きにしてお楽しみください。
        </p>
    </div>

    <!-- ========== タイトル画面 ========== -->
    <div id="title-screen">
        <div>
            <h1 class="title-logo">HATTORI CLUB<br>CARD GAME</h1>
            <p class="title-sub">～ハットリ会会長決定戦～</p>
        </div>
        <div class="mode-buttons">
            <button class="btn-mode btn-online" id="btn-online-game" onclick="showOnlineModal()"
                style="background: linear-gradient(135deg, #00b4d8, #0077b6);">
                🌐 オンライン対戦<br>
                <small style="font-size:0.7rem;opacity:0.8">LAN内の2人対戦</small>
            </button>
            <button class="btn-mode btn-local" id="btn-local-game" onclick="startLocalGame()">
                🤝 ローカル対戦<br>
                <small style="font-size:0.7rem;opacity:0.8">1台の端末で2人で遊ぶ</small>
            </button>
            <button class="btn-mode btn-test" id="btn-test-game" onclick="startTestGame()">
                🧪 カード検証モード<br>
                <small style="font-size:0.7rem;opacity:0.8">カード効果・システム確認</small>
            </button>
            <button class="btn-mode btn-gallery" id="btn-card-gallery" onclick="showCardGallery()">
                📚 カード一覧<br>
                <small style="font-size:0.7rem;opacity:0.8">全カードを確認</small>
            </button>
        </div>
    </div>

    <!-- ========== ゲーム画面 ========== -->
    <div id="game-screen">

        <!-- ゲームトップバー（LP情報・フェイズ表示） -->
        <div class="g-topbar">
            <div class="player-panel" id="p1-panel">
                <div class="player-name" id="p1-name">プレイヤー1</div>
                <div class="lp-display" style="position:relative;">
                    <span class="lp-label">LP</span>
                    <span class="lp-value" id="p1-lp">4000</span>
                    <div id="p1-damage-text" class="damage-text"></div>
                </div>
                <div class="grave-display">
                    <button class="btn-graveyard" onclick="showGraveyard('p1')">🪦 墓地</button>
                    <span id="p1-grave-count" class="grave-count">0</span>
                </div>
            </div>

            <div class="g-topbar-center">
                <div id="turn-badge">ターン 1 | P1 のターン</div>
                <div id="phase-display">ドローフェイズ</div>
            </div>

            <div class="player-panel" id="p2-panel">
                <div class="player-name" id="p2-name">プレイヤー2</div>
                <div class="lp-display" style="position:relative;">
                    <span class="lp-label">LP</span>
                    <span class="lp-value" id="p2-lp">4000</span>
                    <div id="p2-damage-text" class="damage-text"></div>
                </div>
                <div class="grave-display">
                    <button class="btn-graveyard" onclick="showGraveyard('p2')">🪦 墓地</button>
                    <span id="p2-grave-count" class="grave-count">0</span>
                </div>
            </div>
        </div>

        <!-- バトルフィールド（左右分割） -->
        <div class="battle-area">

            <!-- ===== P1 サイド（左半分） ===== -->
            <!-- P1は 左:魔法 / 右:モンスター -->
            <div class="player-side p1-side">
                <div class="field-col">
                    <div class="zone-label">✨ 魔法</div>
                    <div class="field-zone-row" id="p1-magic-zone">
                        <div class="field-slot magic-slot" data-index="0"></div>
                    </div>
                </div>
                <div class="zone-divider"></div>
                <div class="field-col">
                    <div class="zone-label">⚔️ モンスター</div>
                    <div class="field-zone-row" id="p1-monster-zone">
                        <div class="field-slot monster-slot" data-index="0"></div>
                    </div>
                </div>
            </div>

            <!-- 中央仕切り -->
            <div class="field-divider">
                <div class="divider-line"></div>
                <div class="divider-line"></div>
            </div>

            <!-- ===== P2 サイド（右半分） ===== -->
            <!-- P2は 左:モンスター / 右:魔法 -->
            <div class="player-side p2-side">
                <div class="field-col">
                    <div class="zone-label">⚔️ モンスター</div>
                    <div class="field-zone-row" id="p2-monster-zone">
                        <div class="field-slot monster-slot" data-index="0"></div>
                    </div>
                </div>
                <div class="zone-divider"></div>
                <div class="field-col">
                    <div class="zone-label">✨ 魔法</div>
                    <div class="field-zone-row" id="p2-magic-zone">
                        <div class="field-slot magic-slot" data-index="0"></div>
                    </div>
                </div>
            </div>

        </div><!-- /battle-area -->

        <!-- 下部セクション：コントロール + 手札 -->
        <div class="bottom-section" style="pointer-events:none;">
            <!-- ダイス（必要に応じて別の場所で表示、またはDOMのみ残す） -->
            <div class="dice-section" style="display:none; pointer-events:none;">
                <span class="dice-label">ダイス</span>
                <span id="dice-display">🎲</span>
            </div>

            <!-- 手札エリア（画面最下部に固定） -->
            <div class="hand-section">
                <div id="hand-area">
                    <div class="hand-header" style="display:flex; justify-content:center; gap:10px;">
                        <!-- 以前のトグルや攻撃ボタンはJSのrenderHand内またはカード詳細モーダルで処理 -->
                    </div>
                    <div class="hand-cards" style="display: flex;"></div>
                </div>
            </div>
        </div><!-- /bottom-section -->

        <!-- 🍔 メニューボタン群 (右下に固定) -->
        <div class="menu-buttons-container" style="display:flex; flex-direction:row; gap:10px;">
            <button id="log-btn" class="menu-btn" onclick="toggleLogModal()" title="ゲームログ">📋</button>
            <button id="back-title-btn" class="menu-btn" onclick="goToTitle()" title="タイトルへ戻る">🏠</button>
        </div>

    </div><!-- /game-screen -->

    <!-- スマホ向け ログ表示モーダル -->
    <div id="log-modal" class="modal-overlay" style="display:none;" onclick="toggleLogModal()">
        <div class="modal-content" style="height:80vh; display:flex; flex-direction:column;"
            onclick="event.stopPropagation()">
            <h2>📋 プレイヤーログ</h2>
            <div id="log-modal-container" class="log-modal-container"
                style="flex:1; overflow-y:auto; text-align:left; font-size:0.9rem; padding:10px; background:#000; border-radius:8px;">
            </div>
            <button class="btn btn-close" style="margin-top:10px;" onclick="toggleLogModal()">✖ 閉じる</button>
        </div>
    </div>

    <!-- 🌟 墓地一覧モーダル -->
    <div id="graveyard-modal" class="modal-overlay" style="display:none;" onclick="closeGraveyardModal()">
        <div class="modal-content graveyard-content" onclick="event.stopPropagation()">
            <h2 id="graveyard-title">🪦 墓地一覧</h2>
            <div id="graveyard-list" class="graveyard-list"></div>
            <button class="btn btn-close" style="margin-top:15px; width:100%;" onclick="closeGraveyardModal()">✖
                閉じる</button>
        </div>
    </div>

    <!-- 🌟 カード詳細プレビューモーダル -->
    <div id="card-detail-modal" class="modal-overlay" style="display: none;" onclick="closeCardDetail()">
        <div class="modal-content card-detail-content" onclick="event.stopPropagation()">
            <div id="card-detail-view" class="card-large"></div>
            <div id="card-detail-buttons" style="display:flex; justify-content:center; gap:20px; margin-top:15px;">
            </div>
        </div>
    </div>

    <!-- ========== ターン開始インジケータ ========== -->
    <div id="turn-indicator-overlay" class="turn-indicator-overlay" style="display: none;">
        <div id="turn-indicator-text" class="turn-indicator-text"></div>
    </div>

    <!-- ========== プレイヤー切替オーバーレイ ========== -->
    <div id="player-switch-overlay">
        <div class="switch-msg" id="switch-msg">プレイヤー2 のターンです</div>
        <button class="btn btn-end-turn" onclick="dismissPlayerSwitch()">OK（準備できたら）</button>
    </div>

    <!-- ========== ゲームオーバー ========== -->
    <div id="gameover-overlay">
        <div id="gameover-msg">勝者：プレイヤー1</div>
        <div class="gameover-buttons">
            <button class="btn btn-battle" onclick="startNormalGame()">⚔️ もう一度（対戦）</button>
            <button class="btn btn-test" onclick="startTestGame()">🧪 もう一度（テスト）</button>
            <button class="btn btn-back" onclick="goToTitle()">🏠 タイトルへ</button>
        </div>
    </div>

    <!-- ターン交代オーバーレイ (ローカル対戦用) -->
    <div id="turn-overlay" class="turn-overlay" style="display: none;">
        <div class="turn-overlay-content">
            <h2 id="turn-overlay-title">プレイヤー交代</h2>
            <p>次のプレイヤーに交代してください</p>
            <button id="btn-turn-start" class="btn-large">ターン開始</button>
        </div>
    </div>

    <!-- 汎用カード選択モーダル -->
    <div id="card-select-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="card-select-title">カードを選択</h2>
            <div id="card-select-list" class="graveyard-list"></div>
            <button id="btn-card-select-cancel" class="btn-close">キャンセル</button>
        </div>
    </div>

    <!-- ========== オンライン対戦モーダル ========== -->
    <div id="online-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width:420px;">
            <h2>🌐 オンライン対戦</h2>
            <p style="font-size:0.8rem;opacity:0.7;margin-bottom:1rem;">
                専用サーバーを介して対戦します。<br>ホスト側のPCでサーバー(start-server.bat)を起動してください。</p>

            <!-- 作成・参加選択 -->
            <div id="online-create-section">
                <!-- 接続先URL入力 (ローカルIP等を指定可能に) -->
                <input id="online-server-url" type="text" placeholder="ホストのIP・URL (空欄で自動検出)" value=""
                    style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid #555;background:#1a1a2e;color:#fff;font-size:0.9rem;text-align:center;margin-bottom:0.5rem;">
                <button class="btn btn-battle" style="width:100%;margin-bottom:0.5rem;" onclick="onlineCreateRoom()">🤝
                    ルームを作る（ホスト）</button>
                <hr style="border-color:#444;margin:0.75rem 0;">
                <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
                    <input id="online-room-input" type="text" maxlength="4" placeholder="4桁のコード"
                        style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid #555;background:#1a1a2e;color:#fff;font-size:1.1rem;text-align:center;letter-spacing:4px;">
                    <button class="btn btn-end-turn" onclick="onlineJoinRoom()">参加</button>
                </div>
            </div>

            <!-- ホスト: 待機画面 -->
            <div id="online-waiting-section" style="display:none;text-align:center;">
                <p>相手の接続を待っています...</p>
                <div id="online-code-display"
                    style="font-size:3rem;font-weight:bold;letter-spacing:8px;color:#00b4d8;margin:0.5rem 0;"></div>
                <p style="font-size:0.75rem;opacity:0.7">このコードを相手に教えてください</p>
                <button class="btn btn-back" style="margin-top:1rem;" onclick="cancelOnlineHosting()">キャンセル</button>
            </div>

            <!-- ゲスト: 待機画面 -->
            <div id="online-guest-waiting" style="display:none;text-align:center;">
                <p>ホストに接続中...</p>
                <div class="dice-anim">⏳</div>
            </div>

            <button class="btn-close" style="margin-top:1rem;width:100%;"
                onclick="document.getElementById('online-modal').style.display='none'">✖ 閉じる</button>
        </div>
    </div>

    <!-- ゲスト用アクションバー -->
    <div id="guest-action-bar" style="display:none;
        position:fixed;bottom:0;left:0;right:0;background:rgba(0,20,40,0.95);
        padding:0.5rem 1rem;display:flex;gap:0.5rem;align-items:center;
        border-top:2px solid #00b4d8;z-index:500;flex-wrap:wrap;"></div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="cards.js"></script>
    <script src="game.js"></script>

    <script>
        setTimeout(() => { if (typeof startTestGame === 'function') startTestGame(); }, 1500);
    </script>
</body>

</html>